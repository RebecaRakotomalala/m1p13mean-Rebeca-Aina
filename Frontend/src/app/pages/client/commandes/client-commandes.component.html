<!-- Breadcrumb -->
<div class="page-breadcrumb">
  <a routerLink="/" class="breadcrumb-link">Accueil</a>
  <span class="breadcrumb-sep">›</span>
  <span class="breadcrumb-current">Mes Commandes</span>
</div>

<!-- Page Header -->
<div class="page-header">
  <div class="header-left">
    <h1 class="page-title">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
      </svg>
      Mes Commandes
    </h1>
    <p class="page-subtitle">Suivez l'état de vos commandes en temps réel</p>
  </div>
</div>

<!-- Stats Cards -->
<div class="stats-row" *ngIf="!loading && commandes.length > 0">
  <div class="stat-card">
    <div class="stat-icon total">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/>
      </svg>
    </div>
    <div>
      <div class="stat-value">{{ stats.total }}</div>
      <div class="stat-label">Total commandes</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon en-cours">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
    </div>
    <div>
      <div class="stat-value">{{ stats.enCours }}</div>
      <div class="stat-label">En cours</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon livrees">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
    </div>
    <div>
      <div class="stat-value">{{ stats.livrees }}</div>
      <div class="stat-label">Livrées</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon montant">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
    </div>
    <div>
      <div class="stat-value">{{ stats.montantTotal | number:'1.0-0' }} <small>Ar</small></div>
      <div class="stat-label">Montant total</div>
    </div>
  </div>
</div>

<!-- Filters -->
<div class="filters-bar" *ngIf="!loading && commandes.length > 0">
  <div class="search-box">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
    </svg>
    <input type="text" placeholder="Rechercher une commande..." [(ngModel)]="searchTerm" />
  </div>
  <div class="filter-chips">
    <button class="chip" [class.active]="filtreStatut === ''" (click)="filtreStatut = ''">Toutes</button>
    <button class="chip" [class.active]="filtreStatut === 'en_attente'" (click)="filtreStatut = 'en_attente'">En attente</button>
    <button class="chip" [class.active]="filtreStatut === 'confirmee'" (click)="filtreStatut = 'confirmee'">Confirmées</button>
    <button class="chip" [class.active]="filtreStatut === 'en_preparation'" (click)="filtreStatut = 'en_preparation'">Préparation</button>
    <button class="chip" [class.active]="filtreStatut === 'livree'" (click)="filtreStatut = 'livree'">Livrées</button>
    <button class="chip" [class.active]="filtreStatut === 'annulee'" (click)="filtreStatut = 'annulee'">Annulées</button>
  </div>
</div>

<!-- Loading -->
<div *ngIf="loading" class="loading-container">
  <div class="spinner"></div>
  <p>Chargement de vos commandes...</p>
</div>

<!-- Empty State -->
<div *ngIf="!loading && commandes.length === 0" class="empty-state">
  <div class="empty-icon">
    <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1">
      <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
    </svg>
  </div>
  <h3>Aucune commande</h3>
  <p>Vous n'avez pas encore passé de commande.</p>
  <a routerLink="/catalogue" class="btn-primary-custom">Explorer le catalogue</a>
</div>

<!-- No Results -->
<div *ngIf="!loading && commandes.length > 0 && commandesFiltrees.length === 0" class="empty-state small">
  <h4>Aucune commande trouvée</h4>
  <p>Essayez de modifier vos filtres</p>
  <button class="btn-outline-custom" (click)="filtreStatut = ''; searchTerm = ''">Réinitialiser les filtres</button>
</div>

<!-- Orders List -->
<div class="orders-list" *ngIf="!loading">
  <div *ngFor="let cmd of commandesFiltrees; let i = index"
       class="order-card"
       [class.expanded]="isExpanded(cmd._id)"
       [style.animation-delay]="(i * 0.05) + 's'">

    <!-- Order Header (clickable) -->
    <div class="order-header" (click)="toggleExpand(cmd._id)">
      <div class="order-main-info">
        <div class="order-number-row">
          <span class="order-number">{{ cmd.numero_commande }}</span>
          <span class="order-status" [ngClass]="getStatutClass(cmd.statut)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path [attr.d]="getStatutIcon(cmd.statut)"/>
            </svg>
            {{ getStatutLabel(cmd.statut) }}
          </span>
        </div>
        <div class="order-meta">
          <span class="meta-item">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            {{ cmd.date_creation | date:'dd/MM/yyyy à HH:mm' }}
          </span>
          <span class="meta-item">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
            {{ cmd.lignes?.length || 0 }} article{{ (cmd.lignes?.length || 0) > 1 ? 's' : '' }}
          </span>
        </div>
      </div>
      <div class="order-right">
        <div class="order-amount">{{ cmd.montant_total | number:'1.0-0' }} Ar</div>
        <div class="expand-icon" [class.rotated]="isExpanded(cmd._id)">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"/>
          </svg>
        </div>
      </div>
    </div>

    <!-- Order Details (expandable) -->
    <div class="order-details" *ngIf="isExpanded(cmd._id)">
      <!-- Progress Steps -->
      <div class="progress-tracker" *ngIf="cmd.statut !== 'annulee' && cmd.statut !== 'remboursee'">
        <div *ngFor="let step of getProgressSteps(cmd.statut)"
             class="progress-step"
             [class.done]="step.done"
             [class.active]="step.active">
          <div class="step-dot"></div>
          <span class="step-label">{{ step.label }}</span>
        </div>
      </div>
      <div class="cancelled-banner" *ngIf="cmd.statut === 'annulee' || cmd.statut === 'remboursee'">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path [attr.d]="getStatutIcon(cmd.statut)"/>
        </svg>
        Commande {{ getStatutLabel(cmd.statut).toLowerCase() }}
      </div>

      <!-- Products -->
      <div class="products-section">
        <h4 class="section-label">Articles commandés</h4>
        <div *ngFor="let l of cmd.lignes" class="product-row">
          <img [src]="l.image_produit || 'assets/images/authentication/img-placeholder.svg'"
               [alt]="l.nom_produit" class="product-img" />
          <div class="product-info">
            <span class="product-name">{{ l.nom_produit }}</span>
            <span class="product-qty">Qté: {{ l.quantite }} × {{ l.prix_unitaire | number:'1.0-0' }} Ar</span>
          </div>
          <div class="product-total">{{ l.prix_total | number:'1.0-0' }} Ar</div>
        </div>
      </div>

      <!-- Order Info -->
      <div class="info-grid">
        <div class="info-item">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/>
            <circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/>
          </svg>
          <div>
            <small>Livraison</small>
            <strong>{{ getLivraisonLabel(cmd.mode_livraison) }}</strong>
          </div>
        </div>
        <div class="info-item">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/>
          </svg>
          <div>
            <small>Paiement</small>
            <strong>{{ getPaiementLabel(cmd.statut_paiement) }}</strong>
          </div>
        </div>
        <div class="info-item" *ngIf="cmd.frais_livraison > 0">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1"/>
          </svg>
          <div>
            <small>Frais livraison</small>
            <strong>{{ cmd.frais_livraison | number:'1.0-0' }} Ar</strong>
          </div>
        </div>
        <div class="info-item" *ngIf="cmd.adresse_livraison?.rue">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/>
          </svg>
          <div>
            <small>Adresse</small>
            <strong>{{ cmd.adresse_livraison.rue }}, {{ cmd.adresse_livraison.ville }}</strong>
          </div>
        </div>
      </div>

      <!-- Total Summary -->
      <div class="order-summary-footer">
        <div class="summary-line" *ngIf="cmd.sous_total">
          <span>Sous-total</span>
          <span>{{ cmd.sous_total | number:'1.0-0' }} Ar</span>
        </div>
        <div class="summary-line" *ngIf="cmd.frais_livraison > 0">
          <span>Livraison</span>
          <span>{{ cmd.frais_livraison | number:'1.0-0' }} Ar</span>
        </div>
        <div class="summary-line total">
          <span>Total</span>
          <strong>{{ cmd.montant_total | number:'1.0-0' }} Ar</strong>
        </div>
      </div>
    </div>
  </div>
</div>

