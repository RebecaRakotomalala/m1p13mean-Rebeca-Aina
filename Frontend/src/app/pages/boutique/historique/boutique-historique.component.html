<!-- Loading -->
@if (loading) {
  <div class="text-center py-5">
    <div class="spinner-border text-primary spinner-border-lg" role="status"></div>
    <p class="mt-3 text-muted">Chargement de l'historique...</p>
  </div>
}

@if (!loading) {
  <!-- üîù Stats rapides -->
  <div class="row mb-4">
    <div class="col-md-6 col-xl-3 mb-3 fade-in animated">
      <div class="stat-card stat-card-primary">
        <div class="stat-card-body">
          <div class="stat-icon-wrapper stat-icon-primary">
            <i antIcon type="shopping" theme="outline" class="stat-icon-i"></i>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ stats.totalCommandes }}</span>
            <span class="stat-label">Total commandes</span>
            <span class="stat-sub">{{ commandesFiltrees.length }} affich√©(s)</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6 col-xl-3 mb-3 fade-in animated" style="animation-delay: 100ms">
      <div class="stat-card stat-card-success">
        <div class="stat-card-body">
          <div class="stat-icon-wrapper stat-icon-success">
            <i antIcon type="account-book" theme="outline" class="stat-icon-i"></i>
          </div>
          <div class="stat-info">
            <span class="stat-value">{{ (stats.totalVentes / 1000) | number:'1.0-0' }}k</span>
            <span class="stat-label">Total ventes (Ar)</span>
            <span class="stat-sub">{{ stats.meilleurMois || '-' }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6 col-xl-3 mb-3 fade-in animated" style="animation-delay: 200ms">
      <div class="stat-card stat-card-info">
        <div class="stat-card-body">
          <div class="stat-icon-wrapper stat-icon-info">
            <i antIcon type="check-circle" theme="outline" class="stat-icon-i"></i>
          </div>
          <div class="stat-info">
            <span class="stat-value text-info">{{ stats.commandesLivrees }}</span>
            <span class="stat-label">Livr√©es</span>
            <span class="stat-sub">Termin√©es</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6 col-xl-3 mb-3 fade-in animated" style="animation-delay: 300ms">
      <div class="stat-card stat-card-warning">
        <div class="stat-card-body">
          <div class="stat-icon-wrapper stat-icon-warning">
            <i antIcon type="bar-chart" theme="outline" class="stat-icon-i"></i>
          </div>
          <div class="stat-info">
            <span class="stat-value text-warning">{{ (stats.moyennePanier / 1000) | number:'1.0-0' }}k</span>
            <span class="stat-label">Panier moyen (Ar)</span>
            <span class="stat-sub">Par commande</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtres -->
  <div class="slide-in-up animated">
    <app-card>
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label fw-semibold">
            <i antIcon type="search" theme="outline" class="me-1"></i> Rechercher
          </label>
          <input 
            type="text" 
            class="form-control" 
            placeholder="N¬∞ commande, client..."
            [(ngModel)]="searchTerm"
            (ngModelChange)="onFilterChange()"
          >
        </div>
        <div class="col-md-2">
          <label class="form-label fw-semibold">Statut</label>
          <select class="form-select" [(ngModel)]="filterStatut" (ngModelChange)="onFilterChange()">
            @for (s of statuts; track s.value) {
              <option [value]="s.value">{{ s.label }}</option>
            }
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label fw-semibold">
            <i antIcon type="calendar" theme="outline" class="me-1"></i> Du
          </label>
          <input type="date" class="form-control" [(ngModel)]="filterDateDebut" (ngModelChange)="onFilterChange()">
        </div>
        <div class="col-md-2">
          <label class="form-label fw-semibold">Au</label>
          <input type="date" class="form-control" [(ngModel)]="filterDateFin" (ngModelChange)="onFilterChange()">
        </div>
        <div class="col-md-3">
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" (click)="resetFilters()" title="Reset">
              <i antIcon type="reload" theme="outline"></i>
            </button>
            <button class="btn btn-outline-primary" (click)="viewMode = viewMode === 'list' ? 'chart' : 'list'">
              <i antIcon [type]="viewMode === 'list' ? 'bar-chart' : 'history'" theme="outline" class="me-1"></i>
              {{ viewMode === 'list' ? 'Graphiques' : 'Liste' }}
            </button>
            <button class="btn btn-primary" (click)="exportData()">
              <i antIcon type="download" theme="outline" class="me-1"></i> CSV
            </button>
          </div>
        </div>
      </div>
    </app-card>
  </div>

  <!-- Error -->
  @if (error) {
    <div class="alert alert-danger mt-3">
      <i antIcon type="close-circle" theme="outline" class="me-2"></i>
      {{ error }}
    </div>
  }

  <!-- Vue Liste -->
  @if (viewMode === 'list') {
    <app-card cardTitle="Historique ({{ commandesFiltrees.length }})" class="mt-3">
      <div class="table-responsive">
        <table class="table table-hover align-middle stock-table">
          <thead class="table-light">
            <tr>
              <th>N¬∞ Commande</th>
              <th>Client</th>
              <th>Date</th>
              <th>Montant</th>
              <th>Statut</th>
              <th>Paiement</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (cmd of paginatedCommandes; track cmd._id) {
              <tr [class.table-warning]="cmd.statut === 'en_attente'"
                  [class.table-success-light]="cmd.statut === 'livree'">
                <td><strong class="text-primary">{{ cmd.numero_commande }}</strong></td>
                <td>
                  <div>
                    <strong>{{ cmd.client_nom || 'N/A' }}</strong>
                    <br>
                    <small class="text-muted">{{ cmd.client_email || '' }}</small>
                  </div>
                </td>
                <td>
                  <small>{{ cmd.date_creation | date:'dd/MM/yyyy' }}</small>
                  <br>
                  <small class="text-muted">{{ cmd.date_creation | date:'HH:mm' }}</small>
                </td>
                <td>
                  <strong>{{ cmd.montant_total | number:'1.0-0' }} Ar</strong>
                  @if (cmd.frais_livraison > 0) {
                    <br>
                    <small class="text-muted">+ {{ cmd.frais_livraison | number:'1.0-0' }} Ar livr.</small>
                  }
                </td>
                <td>
                  <span class="badge" [ngClass]="getStatutClass(cmd.statut)">
                    {{ getStatutLabel(cmd.statut) }}
                  </span>
                </td>
                <td>
                  <span class="badge" [ngClass]="getPaiementClass(cmd.statut_paiement)">
                    {{ getPaiementLabel(cmd.statut_paiement) }}
                  </span>
                </td>
                <td class="text-end">
                  <button class="btn btn-sm btn-outline-info" (click)="viewDetails(cmd)" title="D√©tails">
                    <i antIcon type="eye" theme="outline"></i>
                  </button>
                </td>
              </tr>
            }

            @if (commandesFiltrees.length === 0) {
              <tr>
                <td colspan="7" class="text-center py-5 text-muted">
                  <i antIcon type="history" theme="outline" class="f-36 d-block mb-2"></i>
                  Aucune commande trouv√©e
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      @if (commandesFiltrees.length > pageSize) {
        <div class="d-flex justify-content-between align-items-center mt-3 px-2">
          <small class="text-muted">
            Affichage {{ (currentPage - 1) * pageSize + 1 }} - {{ currentPage * pageSize > commandesFiltrees.length ? commandesFiltrees.length : currentPage * pageSize }} sur {{ commandesFiltrees.length }}
          </small>
          <nav>
            <ul class="pagination pagination-sm mb-0">
              <li class="page-item" [class.disabled]="currentPage === 1">
                <button class="page-link" (click)="goToPage(currentPage - 1)">‚Äπ</button>
              </li>
              @for (page of pages; track $index) {
                @if (page === -1) {
                  <li class="page-item disabled"><span class="page-link">‚Ä¶</span></li>
                } @else {
                  <li class="page-item" [class.active]="page === currentPage">
                    <button class="page-link" (click)="goToPage(page)">{{ page }}</button>
                  </li>
                }
              }
              <li class="page-item" [class.disabled]="currentPage === totalPages">
                <button class="page-link" (click)="goToPage(currentPage + 1)">‚Ä∫</button>
              </li>
            </ul>
          </nav>
        </div>
      }
    </app-card>
  }

  <!-- Vue Graphiques -->
  @if (viewMode === 'chart') {
    <div class="row g-4 mt-3">
      <div class="col-12 slide-in-left animated">
        <app-card cardTitle="üìà √âvolution des Ventes">
          @if (salesHistoryChartOptions) {
            <apx-chart
              #salesHistoryChart
              [series]="salesHistoryChartOptions.series"
              [chart]="salesHistoryChartOptions.chart"
              [dataLabels]="salesHistoryChartOptions.dataLabels"
              [stroke]="salesHistoryChartOptions.stroke"
              [colors]="salesHistoryChartOptions.colors"
              [xaxis]="salesHistoryChartOptions.xaxis"
              [yaxis]="salesHistoryChartOptions.yaxis"
              [grid]="salesHistoryChartOptions.grid"
              [fill]="salesHistoryChartOptions.fill"
              [tooltip]="salesHistoryChartOptions.tooltip"
            ></apx-chart>
          }
        </app-card>
      </div>

      <div class="col-12 slide-in-right animated">
        <app-card cardTitle="üìä Nombre de Commandes par Jour">
          @if (ordersHistoryChartOptions) {
            <apx-chart
              #ordersHistoryChart
              [series]="ordersHistoryChartOptions.series"
              [chart]="ordersHistoryChartOptions.chart"
              [plotOptions]="ordersHistoryChartOptions.plotOptions"
              [dataLabels]="ordersHistoryChartOptions.dataLabels"
              [colors]="ordersHistoryChartOptions.colors"
              [xaxis]="ordersHistoryChartOptions.xaxis"
              [yaxis]="ordersHistoryChartOptions.yaxis"
              [grid]="ordersHistoryChartOptions.grid"
              [tooltip]="ordersHistoryChartOptions.tooltip"
            ></apx-chart>
          }
        </app-card>
      </div>
    </div>
  }
}

<!-- Modal D√©tails Commande -->
@if (showDetailsModal && selectedCommande) {
  <div class="modal-backdrop fade show" (click)="closeDetailsModal()" style="z-index: 1050;"></div>
  <div class="modal fade show d-block" tabindex="-1" style="z-index: 1055;">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i antIcon type="shopping" theme="outline" class="me-2"></i>
            Commande {{ selectedCommande.numero_commande }}
          </h5>
          <button type="button" class="btn-close" (click)="closeDetailsModal()"></button>
        </div>
        <div class="modal-body">
          <div class="row mb-3">
            <div class="col-md-6">
              <p><strong>Client:</strong> {{ selectedCommande.client_nom }}</p>
              <p><strong>Email:</strong> {{ selectedCommande.client_email }}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Date:</strong> {{ selectedCommande.date_creation | date:'dd/MM/yyyy HH:mm' }}</p>
              <p>
                <strong>Statut:</strong>
                <span class="badge ms-1" [ngClass]="getStatutClass(selectedCommande.statut)">
                  {{ getStatutLabel(selectedCommande.statut) }}
                </span>
              </p>
              <p>
                <strong>Paiement:</strong>
                <span class="badge ms-1" [ngClass]="getPaiementClass(selectedCommande.statut_paiement)">
                  {{ getPaiementLabel(selectedCommande.statut_paiement) }}
                </span>
              </p>
            </div>
          </div>
          <h6>Produits command√©s</h6>
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Produit</th>
                <th>Qt√©</th>
                <th>Prix unit.</th>
                <th class="text-end">Total</th>
              </tr>
            </thead>
            <tbody>
              @for (ligne of selectedCommande.lignes || []; track $index) {
                <tr>
                  <td>{{ ligne.nom_produit }}</td>
                  <td>{{ ligne.quantite }}</td>
                  <td>{{ ligne.prix_unitaire | number:'1.0-0' }} Ar</td>
                  <td class="text-end"><strong>{{ ligne.prix_total | number:'1.0-0' }} Ar</strong></td>
                </tr>
              }
            </tbody>
            <tfoot>
              <tr>
                <td colspan="3" class="text-end fw-bold">Sous-total:</td>
                <td class="text-end">{{ selectedCommande.sous_total | number:'1.0-0' }} Ar</td>
              </tr>
              @if (selectedCommande.frais_livraison > 0) {
                <tr>
                  <td colspan="3" class="text-end fw-bold">Livraison:</td>
                  <td class="text-end">{{ selectedCommande.frais_livraison | number:'1.0-0' }} Ar</td>
                </tr>
              }
              <tr>
                <td colspan="3" class="text-end fw-bold">Total:</td>
                <td class="text-end"><strong class="text-primary">{{ selectedCommande.montant_total | number:'1.0-0' }} Ar</strong></td>
              </tr>
            </tfoot>
          </table>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeDetailsModal()">Fermer</button>
        </div>
      </div>
    </div>
  </div>
}
